# 仮想通貨DCAトレーディングボット：要件定義書

Version: 1.1
Date: 2026-01-28
Status: Draft

## 1. システム概要

### 1.1 目的
Binance Japanを利用した仮想通貨の自動売買システムを構築する。DCA（Dollar Cost Averaging）戦略を採用し、価格下落時に段階的に買い増しを行うことで平均取得単価を下げ、利益を最大化する。

### 1.2 スコープ
- Phase 1-6: ローカル環境（Mac）での開発、バックテスト、Dry Run、ライブ運用
- Phase 7: Docker化とVPS移行
- 将来拡張: Grid Trading戦略の追加（本要件定義では対象外）

### 1.3 主要ステークホルダー
- 開発者/運用者: トレーディングボットの構築・運用・監視を行う個人
- Binance Japan: 取引所API提供者
- Telegram: 通知チャネル提供者

---

## 2. 機能要件

### 2.1 トレーディング機能

#### FR-001: DCA初回注文
- 概要: 市場状況が適切なタイミングで初回注文を発注
- 入力:
  - テクニカル指標（EMA、RSI、ボリンジャーバンド）
  - 出来高データ
- 処理:
  - エントリーシグナル判定（bullish条件 + 出来高確認）
  - 初回注文サイズ = 設定stake_amount / max_dca_multiplier（5.5）
- 出力: 市場注文（Market Order）

#### FR-002: DCA追加購入（ナンピン）
- 概要: 価格下落時に段階的に買い増し
- 入力:
  - 現在ポジションの含み損率
  - オープンオーダーの有無
  - 直前ローソク足の価格推移
- 処理:
  - DCA 1回目: 含み損 -7%時、基準額 x 1.25（Hyperopt範囲: -5%〜-10%）
  - DCA 2回目: 含み損 -12%時、基準額 x 1.50（Hyperopt範囲: -8%〜-15%）
  - DCA 3回目: 含み損 -18%時、基準額 x 1.75（Hyperopt範囲: -12%〜-20%）
  - 制約: 最大3回まで、下落中は実行しない
  - 備考: 閾値はHyperoptで最適化可能
- 出力: 市場注文（追加購入）

#### FR-003: 利確（Take Profit）
- 概要: 目標利益率到達時の自動利確
- 入力: 現在ポジションの含み益率
- 処理:
  - 部分利確: +8%到達時、ポジションの33%を売却（Hyperopt範囲: +5%〜+15%、売却率: 25%〜50%）
  - トレーリングストップ: +8%到達後、+3%でトレーリング開始
  - 備考: 利確閾値と売却率はHyperoptで最適化可能
- 出力: 市場注文（売却）

#### FR-004: ストップロス
- 概要: 損失を限定するための強制決済
- 入力: 現在ポジションの含み損率
- 処理:
  - 固定ストップロス: -20%到達時、全ポジション強制決済
- 出力: 市場注文（全売却）

#### FR-014: スリッページ保護
- 概要: 注文時の価格乖離を制限
- 入力: 注文予定価格、現在市場価格
- 処理:
  - スリッページ許容範囲: 0.5%
  - 許容範囲超過時は注文をスキップ
- 出力: 警告通知（Telegram）

#### FR-015: 市場環境判定
- 概要: トレンド方向と強度を判定し、エントリーを制御
- 入力: 長期EMA（50/200）、ADX
- 処理:
  - ベアトレンド判定: EMA50 < EMA200 かつ ADX > 25
  - サイドウェイ判定: ADX < 20
  - ベアトレンド時はエントリー抑制
- 出力: 市場環境フラグ（bullish/bearish/sideways）

### 2.2 リスク管理機能

#### FR-005: ポジションサイズ制限
- 概要: 1トレードあたりの最大投資額を制限
- 制約:
  - 1ペアあたりの最大stake_amount: 設定値
  - 最大同時オープンポジション数: max_open_trades

#### FR-006: サーキットブレーカー
- 概要: 急激な損失発生時の自動停止
- 入力: ポートフォリオ全体のドローダウン率
- 処理:
  - ドローダウン15%到達時、新規注文を48キャンドル停止
  - 復帰条件: 48キャンドル経過 AND ドローダウン < 10%
  - 復帰時はTelegram通知
- 出力: 取引停止通知

#### FR-007: ストップロスガード
- 概要: 短期間での連続損失を防止
- 入力: 直近24時間のストップロス発生回数
- 処理:
  - 24時間以内に3回ストップロス発生時、新規注文停止
- 出力: 取引停止通知

#### FR-008: クールダウン期間
- 概要: ストップロス後の再エントリー制限
- 入力: 最後のストップロス発生時刻
- 処理:
  - ストップロス後、3キャンドル期間は新規注文禁止
- 出力: エントリー抑制

### 2.3 通知機能

#### FR-009: Telegram通知
- 概要: 重要イベントの即時通知
- 通知対象:
  - 新規注文発注
  - DCA追加購入
  - 利確・損切り
  - エラー発生
  - サーキットブレーカー発動
- 出力: Telegramメッセージ

#### FR-010: ステータス照会
- 概要: Telegram経由でのボット状態確認
- コマンド:
  - `/status`: 現在のポジション、収益率
  - `/balance`: 残高確認
  - `/stop`: ボット停止
  - `/start`: ボット再開
- 出力: Telegramメッセージ

#### FR-016: ポジション手動クローズ
- 概要: Telegramからの緊急決済コマンド
- 入力: `/forceclose [pair]` コマンド
- 処理: 指定ペアの全ポジションを市場価格で決済
- 出力: 決済確認通知

### 2.4 データ管理機能

#### FR-011: 価格データ取得
- 概要: 取引所からOHLCVデータをダウンロード
- 入力: ペア名、時間足、期間
- 処理: Binance APIからダウンロード
- 出力: ローカルJSONファイル

#### FR-012: バックテスト実行
- 概要: 過去データでの戦略検証
- 入力:
  - 戦略クラス
  - データ期間
  - 初期資金
- 処理:
  - 手数料、スリッページを含めたシミュレーション
  - パフォーマンスメトリクス計算
- 出力:
  - バックテストレポート（HTML/JSON）
  - メトリクス（勝率、PF、Sharpe比、DD等）

#### FR-013: パラメータ最適化（Hyperopt）
- 概要: 戦略パラメータの自動最適化
- 入力:
  - 最適化対象パラメータの範囲
  - 目的関数（Sharpe比等）
  - エポック数
- 処理: ベイズ最適化によるパラメータ探索
- 出力: 最適パラメータセット

---

## 3. 非機能要件

### 3.1 パフォーマンス要件

#### NFR-001: API応答時間
- Binance API呼び出しのタイムアウト: 10秒
- レート制限: 200ms/リクエスト（ccxt enableRateLimit使用）

#### NFR-002: ボット稼働率
- 目標稼働率: 99%以上（Dry Run期間中）
- 計画停止を除く予期しない停止: 月1回以内

### 3.2 セキュリティ要件

#### NFR-003: APIキー管理
- APIキーは環境変数（.envファイル）で管理
- .envファイルは.gitignoreに含める
- APIキー権限: Spot Tradingのみ、出金権限なし
- IP制限: VPS固定IPのみ許可（ライブ運用時）

#### NFR-004: シークレット情報の保護
- Telegramトークン、チャットIDも環境変数管理
- リポジトリにハードコードしない
- ログにシークレットを出力しない

### 3.3 保守性要件

#### NFR-005: コードカバレッジ
- ユニットテストカバレッジ: 80%以上
- 全テスト実行時間: 5分以内

#### NFR-006: ログ記録
- 全トレード実行ログを記録（日時、ペア、価格、数量、理由）
- エラーログは詳細スタックトレース含む
- ログローテーション: 7日分保持

#### NFR-007: ドキュメント整備
- README.md: プロジェクト概要、セットアップ手順
- 各モジュールのdocstring
- 設定ファイルのコメント

### 3.4 可用性要件

#### NFR-008: 障害復旧
- プロセス停止時の自動再起動（systemd or Docker restart policy）
- APIエラー時のリトライ機構（最大3回、指数バックオフ）

#### NFR-009: 監視
- ボット稼働状態の監視（Telegram `/status`）
- 異常検知時の即時通知

#### NFR-011: 外部監視（ハートビート）
- 5分ごとに外部サービス（UptimeRobot等）にハートビート送信
- ハートビート途絶時に別チャネル（メール等）で通知
- ハートビートURL: 環境変数 HEARTBEAT_URL で設定

#### NFR-012: バックアップと復旧
- tradesv3.sqliteの日次バックアップ
- バックアップ保持期間: 30日
- 復旧手順のドキュメント化

### 3.5 設定検証要件

#### NFR-010: 設定検証
- 起動時に設定ファイルのスキーマ検証を実施
- 必須パラメータ欠落時はエラー終了
- dry_run: false かつ stake_amount > 50,000 の場合は確認プロンプト表示
- 無効な値（負のstake_amount等）の検出と拒否

---

## 4. システム制約

### 4.1 技術制約
- プログラミング言語: Python 3.11以上
- トレーディングフレームワーク: Freqtrade 2024.x以上
- 取引所: Binance Japan
- 通知システム: Telegram Bot API
- 開発環境: macOS（ローカル）
- 本番環境: Linux（VPS、Phase 7以降）

### 4.2 取引所制約
- 取引ペア: BTC/JPY, ETH/JPY（Binance Japanで利用可能）
- 最小注文サイズ:
  - BTC/JPY: 0.0001 BTC（約1,000円、1BTC=10,000,000円想定）
  - ETH/JPY: 0.001 ETH（約300円、1ETH=300,000円想定）
- 手数料:
  - Maker: 0.05%（BNB払いで0.04%）
  - Taker: 0.05%（BNB払いで0.04%）
- レート制限（Weight）: 1分あたり1200
- メンテナンス時間: 不定期（Binance通知で確認）
- 最大注文サイズ: BTC/JPY 10 BTC、ETH/JPY 100 ETH
- 価格精度: 1円
- 数量精度: BTC 0.00001、ETH 0.0001

### 4.3 資金制約
- 初期投資額: 5万円 〜 30万円
- 推奨最小額: 5万円（DCA 3回分の余裕を確保）
- 1ペアあたりの配分: 総資金 / max_open_trades

### 4.4 運用制約
- Phase 1-6: Dry Runモード（実資金なし）
- Dry Run期間: 最低2週間
- ライブ移行条件:
  - バックテスト合格
  - Dry Run稼働率99%以上
  - APIエラー率1%未満

---

## 5. インターフェース要件

### 5.1 外部システムインターフェース

#### IF-001: Binance Japan REST API
- プロトコル: HTTPS
- 認証: HMAC SHA256署名
- エンドポイント: `https://api.binance.com`
- 使用API:
  - `/api/v3/ticker/price`: 現在価格取得
  - `/api/v3/order`: 注文発注
  - `/api/v3/account`: 残高照会
  - `/api/v3/myTrades`: 取引履歴取得

#### IF-002: Telegram Bot API
- プロトコル: HTTPS
- 認証: Botトークン
- エンドポイント: `https://api.telegram.org/bot<token>/`
- 使用API:
  - `sendMessage`: メッセージ送信
  - `getUpdates`: コマンド受信

### 5.2 ユーザーインターフェース

#### IF-003: コマンドラインインターフェース
- ボット起動: `freqtrade trade --config config.json --strategy DCAStrategy`
- バックテスト: `freqtrade backtesting --config config.backtest.json --strategy DCAStrategy`
- Hyperopt: `freqtrade hyperopt --config config.hyperopt.json --strategy DCAStrategy --epochs 500`

#### IF-004: Telegram CLI
- ステータス確認: `/status`
- 残高確認: `/balance`
- ボット停止: `/stop`
- ボット開始: `/start`
- ヘルプ: `/help`

---

## 6. データ要件

### 6.1 入力データ
- OHLCV（Open, High, Low, Close, Volume）データ
  - 時間足: 1h（メイン）、4h、1d（補助）
  - 期間: 2024年3月〜現在（Binance Japan BTC/JPY開始日以降）
- 取引所残高情報
- 現在のオープンポジション情報

### 6.2 出力データ
- トレード実行ログ（CSV/JSON）
- バックテストレポート（HTML/JSON）
- パフォーマンスメトリクス（JSON）
- Telegram通知メッセージ

### 6.3 データ保持期間
- OHLCVデータ: 無期限（バックテスト用）
- トレードログ: 1年間
- アプリケーションログ: 7日間

---

## 7. 品質要件

### 7.1 バックテスト合格基準

| メトリクス | 最低基準 | 目標値 |
|-----------|---------|--------|
| 勝率 | >= 50% | >= 60% |
| プロフィットファクター | >= 1.2 | >= 1.5 |
| Sharpe比 | >= 0.5 | >= 1.0 |
| 最大ドローダウン | <= 20% | <= 15% |
| Out-of-sample劣化率 | <= 30% | <= 15% |
| 最低トレード数 | >= 30 | - |

追加項目:
- モンテカルロシミュレーション: 100回以上実施
- スリッページ考慮: 0.1%〜0.5%を追加考慮
- 推奨バックテスト期間: 最低18ヶ月以上

### 7.2 Dry Run合格基準

| メトリクス | 基準 |
|-----------|------|
| 稼働率 | >= 99% |
| APIエラー率 | < 1% |
| 注文正確性 | 100% |
| バックテストとの乖離 | Sharpe比差 0.3以内 |

---

## 8. リスク管理要件

### 8.1 ポジションレベルリスク

| リスク管理項目 | 設定値 | 実装方法 |
|---------------|--------|---------|
| 最大ストップロス | -20% | stoploss = -0.20 |
| トレーリングストップ | +2%（+5%到達後） | trailing_stop設定 |
| DCA最大回数 | 3回 | max_entry_position_adjustment = 3 |
| 部分利確 | +5%で50%売却 | adjust_trade_position内 |

### 8.2 ポートフォリオレベルリスク

| リスク管理項目 | 設定値 | 実装方法 |
|---------------|--------|---------|
| 最大同時ポジション | 2-3 | max_open_trades |
| サーキットブレーカー | DD 15% | MaxDrawdownプロテクション |
| ストップロスガード | 24h内3回SL | StoplossGuardプロテクション |
| クールダウン | SL後3キャンドル | CooldownPeriodプロテクション |

### 8.3 段階的資金投入計画

| 期間 | 投入資金 | 目的 |
|------|---------|------|
| Week 1 | 1-2万円 | 実運用環境での動作確認 |
| Week 2 | 5万円 | ポジション管理の検証 |
| Week 3-4 | 目標金額（10-30万円） | フルスケール運用 |

### 8.4 最大損失シナリオ分析

| シナリオ | 条件 | 最大損失額 | 備考 |
|----------|------|-----------|------|
| 通常運用 | stake_amount=10,000円 | 2,000円 | 20% x 10,000円 |
| DCA全投入後SL | 全DCA実行後 | 11,000円 | 20% x 55,000円（5.5倍） |
| フラッシュクラッシュ | 瞬間-30%下落 | 16,500円 | SL間に合わず |
| 2ポジション同時SL | 両方-20%到達 | 22,000円 | max_open_trades=2 |

注意: 上記は最悪ケースの想定。実際のリスク許容度に応じてstake_amountを設定すること。

---

## 9. 用語集

| 用語 | 説明 |
|-----|------|
| DCA | Dollar Cost Averaging。価格下落時に段階的に買い増しすることで平均取得単価を下げる戦略。 |
| ナンピン | 日本語でのDCA同義語。下落時の買い増し。 |
| Dry Run | 実資金を使わずに模擬取引を行うモード。Paper Tradingと同義。 |
| Hyperopt | ハイパーパラメータ最適化。戦略のパラメータを自動で最適化する手法。 |
| Sharpe比 | リスク調整後リターンの指標。高いほど効率的。 |
| プロフィットファクター | 総利益 / 総損失。1以上で利益、高いほど優秀。 |
| ドローダウン | 最高資産額からの下落率。 |
| ウォークフォワード分析 | データを複数期間に分割し、In-sample最適化とOut-of-sample検証を繰り返す手法。 |
| In-sample | 最適化に使用するデータ期間。 |
| Out-of-sample | 検証に使用するデータ期間（最適化には使わない）。 |
| OHLCV | Open, High, Low, Close, Volume。ローソク足データ。 |
| Maker | 注文板に流動性を提供する注文（指値注文）。 |
| Taker | 注文板から流動性を取る注文（成行注文）。 |
| スリッページ | 注文時の想定価格と実際の約定価格の差。 |
| サーキットブレーカー | 急激な損失時に取引を自動停止する機能。 |
| プロテクション | Freqtradeのリスク管理機能群（CooldownPeriod, MaxDrawdown等）。 |

---

## 10. 承認

| 役割 | 氏名 | 承認日 | 署名 |
|-----|------|--------|------|
| 要件定義者 | - | 2026-01-27 | - |
| レビュアー | - | - | - |

---

## 11. 変更履歴

| バージョン | 日付 | 変更者 | 変更内容 |
|-----------|------|--------|---------|
| 1.0 | 2026-01-27 | Claude | 初版作成 |
| 1.1 | 2026-01-28 | Claude | 機能要件追加（FR-014〜FR-016）、非機能要件追加（NFR-010〜NFR-012）、既存要件修正（FR-002, FR-003, FR-006）、制約・品質・リスク管理要件の追加 |

---

## 12. 付録

### A. 参考資料
- [[Flow/Project/20260127_crypto_trading_automation]] - 市場調査レポート
- Freqtrade公式ドキュメント: https://www.freqtrade.io/
- Binance API仕様: https://binance-docs.github.io/apidocs/

### B. 関連ドキュメント
- [[Flow/Project/crypto_dca_bot_implementation_guide]] - 実装計画書（本ドキュメント作成後に作成予定）
